# üßæ API de Controle de Estoque e Vendas

Aplica√ß√£o backend desenvolvida em **Laravel** para gerenciamento de **produtos**, **estoque** e **vendas**, com foco em **performance**, **concorr√™ncia**, **processamento ass√≠ncrono** e **observabilidade**.

---

## üìö Sum√°rio

- [Vis√£o Geral](#-vis√£o-geral)
- [Arquitetura e Tecnologias](#-arquitetura-e-tecnologias)
- [Requisitos](#-requisitos)
- [Como Executar (Docker)](#-como-executar-docker)
- [Execu√ß√£o Local (sem Docker)](#-execu√ß√£o-local-sem-docker)
- [Testes e Cobertura](#-testes-e-cobertura)
 - [Cobertura de C√≥digo (atual)](#-cobertura-de-c√≥digo-atual)
- [Filas e Agendador](#-filas-e-agendador)
- [Estrutura do Projeto](#-estrutura-do-projeto)
- [Servi√ßos adicionais e como acessar](#-servi√ßos-adicionais-e-como-acessar)
- [Estrutura do Projeto (detalhada)](#-estrutura-do-projeto-detalhada)
- [Observabilidade e M√©tricas](#-observabilidade-e-m√©tricas)
- [Endpoints Principais](#-endpoints-principais)
- [Otimiza√ß√µes e Estrat√©gias](#-otimiza√ß√µes-e-estrat√©gias)
- [Valida√ß√£o Local](#-valida√ß√£o-local)
- [Melhorias Futuras](#-melhorias-futuras)
- [Autor](#-autor)

---

## üéØ Vis√£o Geral

Esta API foi projetada para demonstrar boas pr√°ticas de desenvolvimento backend em **Laravel 12**, implementando recursos modernos como **processamento em filas**, **cache inteligente**, **transa√ß√µes idempotentes** e **mecanismos de concorr√™ncia** para garantir integridade dos dados em opera√ß√µes cr√≠ticas.

O sistema simula o m√≥dulo de controle de estoque e vendas de um ERP, oferecendo endpoints para:
- Registro e consulta de produtos e invent√°rio
- Processamento de vendas com m√∫ltiplos itens
- Relat√≥rios filtr√°veis por data e SKU
- M√©tricas e observabilidade simplificadas

---

## üß© Arquitetura e Tecnologias

- **Framework:** Laravel 12
- **Linguagem:** PHP 8.4
- **Banco de Dados:** MySQL 8.4
- **Filas e Cache:** Redis
- **Testes:** PHPUnit
- **Scheduler:** Cron Jobs via Laravel Scheduler
- **Observabilidade:** M√©tricas via endpoint Prometheus-style

---

## üß± Arquitetura Hexagonal (Ports & Adapters)

A aplica√ß√£o segue **Arquitetura Hexagonal** para isolar o **Dom√≠nio** das preocupa√ß√µes de infraestrutura, promovendo testabilidade e facilidade de evolu√ß√£o. Em alto n√≠vel:

```
[Drivers/Entradas] ‚Üí Application (Use Cases) ‚Üí Domain (Entities/Services) ‚Üí [Ports] ‚Üí Adapters (Infra)
```

### Camadas e mapeamento de pastas

- **Domain** (`app/Domain`)
  - **Entities**: modelos ricos de dom√≠nio (ex.: `InventoryItem`, `SaleAggregate`).
  - **Services**: regras de neg√≥cio puras (`StockPolicy`, `MarginCalculator`, `SaleValidator`).
  - **ValueObjects**: tipos imut√°veis (`Money`, `DateRange`).
  - **Enums/Exceptions**: estados e falhas de dom√≠nio (`SaleStatus`, `InventoryInsufficientException`).

- **Shared/Contracts (Ports)** (`app/Domain/Shared/Contracts`)
  - **RepositoryInterface**, **CacheInterface**: definem contratos que a camada de aplica√ß√£o usa sem conhecer a implementa√ß√£o.

- **Application (Use Cases)** (`app/Application/**/UseCases`)
  - Orquestram fluxos, transa√ß√µes e integra√ß√£o com portas: `CreateSale`, `FinalizeSale`, `GetSaleDetails`, `GetInventorySnapshot`, `RegisterStockEntry`, `CleanupOldInventory`, `GenerateSalesReport`.
  - Coordenam **eventos** e **jobs** sem conter regra de neg√≥cio detalhada.

- **Adapters/Infra** (`app/Infrastructure`)
  - **Persistence/Eloquent**: reposit√≥rios concretos (`ProductRepository`, `InventoryRepository`, `SaleRepository`, `SaleItemRepository`).
  - **Queries (read models)**: consultas otimizadas para endpoints (`InventoryQuery`, `SaleDetailsQuery`, `SalesReportQuery`).
  - **Cache**: `InventoryCache` implementa caching com versionamento.
  - **Locks**: `RedisLock` para controle de concorr√™ncia.
  - **Events/Listeners/Jobs**: integra√ß√£o ass√≠ncrona (`SaleFinalized`, `UpdateInventoryListener`, `FinalizeSaleJob`, `UpdateInventoryJob`).
  - **Metrics**: `MetricsCollector` para observabilidade m√≠nima.

- **Drivers (Primary Adapters)**
  - **HTTP** (`app/Http`): controllers, requests e resources (`InventoryController`, `SaleController`, etc.)
  - **Providers** (`app/Providers`): IoC/DI e rate limiting.

### Fluxo t√≠pico (exemplo de venda)

1. **HTTP** chama `POST /api/sales` ‚Üí `SaleController` valida `CreateSaleRequest`.
2. **Application** executa `CreateSale` (orquestra√ß√£o) e publica evento `SaleFinalized`.
3. **Listener** aciona `UpdateInventoryJob` em **fila**.
4. **Job** usa **portas** (reposit√≥rios, cache, locks) para atualizar estoque:
   - Decremento at√¥mico no banco com **WHERE quantity >= ?**.
   - **RedisLock** por SKU opcional para serializar contenda.
   - **Transa√ß√£o + idempot√™ncia** para reprocessamentos seguros.
5. **Cache** de invent√°rio √© invalidado por **versionamento**.

### Benef√≠cios pr√°ticos

- **Testabilidade**: Dom√≠nio e casos de uso testados sem subir framework/banco.
- **Evolu√ß√£o segura**: troca de adapters (p.ex., Eloquent ‚Üí outro ORM) sem afetar o dom√≠nio.
- **Performance e resili√™ncia**: separa√ß√£o expl√≠cita de **read models** (`Queries`) e **write models** (regras de dom√≠nio), com filas e locks para cen√°rios concorrentes.
- **Claridade arquitetural**: cada mudan√ßa tem lugar definido (regra de neg√≥cio no dom√≠nio, orquestra√ß√£o na aplica√ß√£o, integra√ß√£o na infraestrutura).

---

## ‚öôÔ∏è Requisitos

- PHP 8.1+
- Composer
- Docker & Docker Compose (recomendado)
- Banco de dados configurado (MySQL/PostgreSQL/SQLite)

---

## üöÄ Como Executar (Docker)

```bash
cp backend/.env.example backend/.env
docker-compose up -d --build
docker compose exec backend php artisan migrate --seed
```

A API ficar√° dispon√≠vel conforme definido no arquivo `docker-compose.yml` (porta padr√£o: `8000`).

---

## üíª Execu√ß√£o Local (sem Docker)

```bash
cd backend
composer install
cp .env.example .env
php artisan key:generate
php artisan migrate --seed
php artisan serve --host=0.0.0.0 --port=8000
```

---

## üß™ Testes e Cobertura

Rodar todos os testes unit√°rios e de integra√ß√£o:

```bash
cd backend
./vendor/bin/phpunit
```

Testes principais de integra√ß√£o e concorr√™ncia:

```bash
./vendor/bin/phpunit tests/Feature/Integration/SaleFlowIntegrationTest.php \
  tests/Feature/Integration/ConcurrentSalesTest.php \
  tests/Feature/Integration/IdempotentRetryJobTest.php
```

---

## üïì Filas e Agendador

### Local (sem Docker)

```bash
php artisan queue:work --tries=3 --sleep=3 --queue=default,inventory,sales
php artisan schedule:run
```

### Com Docker

```bash
docker compose exec backend php artisan queue:work --tries=3 --sleep=3 --queue=default,inventory,sales
docker compose exec backend php artisan schedule:run
```

> O projeto utiliza **Redis** como driver de fila/cache. Horizon pode ser configurado para monitoramento em produ√ß√£o.

---

## üß± Estrutura do Projeto

```
app/           -> C√≥digo principal (Domain, Application, Infrastructure)
routes/        -> Defini√ß√£o de rotas
config/        -> Configura√ß√µes da aplica√ß√£o
database/      -> Migrations, factories e seeders
tests/         -> Testes automatizados
```

## üõ†Ô∏è Servi√ßos adicionais e como acessar

O projeto traz configura√ß√µes e/ou exemplos para executar servi√ßos que tipicamente acompanham uma aplica√ß√£o Laravel em produ√ß√£o e em ambiente de desenvolvimento com Docker. Abaixo est√£o os servi√ßos com instru√ß√µes r√°pidas de acesso, portas padr√£o (quando aplic√°vel) e vari√°veis de ambiente relevantes.

- MySQL
  - Uso: banco de dados principal da aplica√ß√£o.
  - Porta padr√£o (host): 3306 (pode ser mapeada no `docker-compose.yml`).
  - Vari√°veis importantes: `DB_HOST`, `DB_PORT`, `DB_DATABASE`, `DB_USERNAME`, `DB_PASSWORD` (arquivo `backend/.env`).
  - Acessar via CLI do container:

    ```bash
    docker compose exec backend mysql -h$DB_HOST -P$DB_PORT -u$DB_USERNAME -p$DB_PASSWORD $DB_DATABASE
    ```

- Redis
  - Uso: driver de cache, sess√£o e filas (queues/Horizon).
  - Porta padr√£o (host): 6379.
  - Vari√°veis: `REDIS_HOST`, `REDIS_PORT`, `REDIS_PASSWORD`.
  - Exemplo para checar chaves:

    ```bash
    docker compose exec redis redis-cli -h 127.0.0.1 -p 6379 ping
    ```

- Nginx (proxy reverso)
  - Uso: servir `public/` e rotear para o container PHP-FPM em produ√ß√£o/local via Docker.
  - Configura√ß√£o: `deploy/nginx/default.conf` cont√©m um exemplo de configura√ß√£o.
  - Porta padr√£o (host): 80/443 (ajust√°vel no `docker-compose.yml`).

- PHP-FPM / Backend container
  - Uso: executa o Laravel (arquivo `backend/Dockerfile`, `deploy/php/fpm.conf`).
  - Entrypoint: `backend/entrypoint.sh`.
  - Para executar comandos artisan:

    ```bash
    docker compose exec backend php artisan migrate --seed
    docker compose exec backend php artisan queue:work --once
    ```

- Horizon (opcional)
  - Uso: painel e processo de filas para Redis (se estiver habilitado).
  - Como rodar: dentro do container `backend` execute `php artisan horizon` ou configure no `docker-compose`.
  - URL de monitoramento (se exposto): normalmente algo como `http://localhost:8080/horizon` dependendo do mapeamento.

- Observability stack (Prometheus, Grafana, Alertmanager)
  - Prometheus
    - Uso: coletor/raspador de m√©tricas (ex.: endpoint `/api/v1/observability/metrics`).
    - Arquivo de exemplo na pasta `monitoring/prometheus/`.
    - Porta padr√£o: 9090.
  - Grafana
    - Uso: dashboard visual (ex.: importar `monitoring/grafana/dashboards/` quando dispon√≠vel).
    - Porta padr√£o: 3000.
  - Alertmanager
    - Uso: gerenciar alertas enviados pelo Prometheus.
    - Porta padr√£o: 9093.

- Acesso aos servi√ßos via Docker Compose
  - Subir tudo:

    ```bash
    docker-compose up -d --build
    ```

  - Verificar logs:

    ```bash
    docker compose logs -f backend
    docker compose logs -f redis
    docker compose logs -f mysql
    ```

## üîç Estrutura do Projeto (detalhada)

Uma vis√£o expandida das pastas principais e seus prop√≥sitos para facilitar navega√ß√£o e contribui√ß√£o:

```
backend/                       -> Container/backend Laravel
  ‚îú‚îÄ app/                       -> C√≥digo principal da aplica√ß√£o
  ‚îÇ   ‚îú‚îÄ Application/           -> Casos de uso / orquestra√ß√£o (Use Cases)
  ‚îÇ   ‚îÇ   ‚îú‚îÄ Inventory/         -> Use cases relacionados a invent√°rio
  ‚îÇ   ‚îÇ   ‚îú‚îÄ Reports/           -> Use cases para gera√ß√£o de relat√≥rios
  ‚îÇ   ‚îÇ   ‚îî‚îÄ Sales/             -> Use cases relacionados a vendas
  ‚îÇ   ‚îú‚îÄ Domain/                -> Entidades, Value Objects e regras de neg√≥cio
  ‚îÇ   ‚îÇ   ‚îú‚îÄ Inventory/
+  ‚îÇ   ‚îÇ   ‚îú‚îÄ Sales/
  ‚îÇ   ‚îÇ   ‚îî‚îÄ Shared/
  ‚îÇ   ‚îú‚îÄ Exceptions/            -> Formata√ß√£o e tratamento de exce√ß√µes
  ‚îÇ   ‚îú‚îÄ Http/                  -> Controllers, Requests, Resources, Middleware
  ‚îÇ   ‚îÇ   ‚îú‚îÄ Controllers/
  ‚îÇ   ‚îÇ   ‚îú‚îÄ Middleware/
  ‚îÇ   ‚îÇ   ‚îú‚îÄ Requests/
  ‚îÇ   ‚îÇ   ‚îî‚îÄ Resources/
  ‚îÇ   ‚îú‚îÄ Infrastructure/        -> Adapters para infra (cache, persistence, locks, jobs)
  ‚îÇ   ‚îÇ   ‚îú‚îÄ Cache/
  ‚îÇ   ‚îÇ   ‚îú‚îÄ Events/
  ‚îÇ   ‚îÇ   ‚îú‚îÄ Jobs/
  ‚îÇ   ‚îÇ   ‚îú‚îÄ Listeners/
  ‚îÇ   ‚îÇ   ‚îú‚îÄ Locks/
  ‚îÇ   ‚îÇ   ‚îú‚îÄ Metrics/
  ‚îÇ   ‚îÇ   ‚îî‚îÄ Persistence/
  ‚îÇ   ‚îú‚îÄ Models/                -> Eloquent models (Product, Inventory, Sale, SaleItem, User)
  ‚îÇ   ‚îî‚îÄ Providers/             -> Service providers e bindings de IoC
  ‚îú‚îÄ bootstrap/                 -> bootstrap do framework e cache de providers
  ‚îú‚îÄ config/                    -> Arquivos de configura√ß√£o (database, queue, cache, observability)
  ‚îú‚îÄ database/                  -> Migrations, factories e seeders
  ‚îÇ   ‚îú‚îÄ factories/
  ‚îÇ   ‚îú‚îÄ migrations/
  ‚îÇ   ‚îî‚îÄ seeders/
  ‚îú‚îÄ public/                    -> Ponto de entrada web (index.php)
  ‚îú‚îÄ resources/                 -> Views, assets e lang (se aplic√°vel)
  ‚îú‚îÄ routes/                    -> Arquivos de rotas (`api.php`, `web.php`, `console.php`)
  ‚îú‚îÄ storage/                   -> Logs, cache, uploads tempor√°rios
  ‚îî‚îÄ tests/                     -> Testes Unit√°rios e de Feature
      ‚îú‚îÄ Feature/
      ‚îî‚îÄ Unit/

deploy/                        -> Configura√ß√µes para deploy (Nginx, PHP-FPM, opcache)
  ‚îú‚îÄ nginx/
  ‚îÇ   ‚îî‚îÄ default.conf
  ‚îî‚îÄ php/
      ‚îú‚îÄ fpm.conf
      ‚îî‚îÄ opcache.ini

monitoring/                    -> Configs e dashboards para Prometheus/Grafana/Alertmanager
  ‚îú‚îÄ alertmanager/
  ‚îú‚îÄ grafana/
  ‚îî‚îÄ prometheus/

docs/                          -> Documenta√ß√£o adicional e notas arquiteturais
coverage/                      -> Resultados de cobertura gerados pelo PHPUnit

README.md                      -> Este arquivo
docker-compose.yml             -> Defini√ß√µes dos servi√ßos para desenvolvimento e integra√ß√£o
"""

---

## üìä Observabilidade e M√©tricas

Endpoint de m√©tricas estilo Prometheus:
```bash
GET /api/v1/observability/metrics
```

- Protegido por IP (`config/observability.php > allowed_ips`)
- Pode ser configurado via vari√°vel `OBS_ALLOWED_IPS`
- Ideal para scraping por Prometheus local ou remoto

---

## üîó Endpoints Principais

| M√©todo | Endpoint | Descri√ß√£o |
|--------|-----------|------------|
| `POST` | `/api/inventory` | Registrar entrada de produtos no estoque |
| `GET` | `/api/inventory` | Consultar situa√ß√£o atual do estoque (cacheada) |
| `POST` | `/api/sales` | Registrar nova venda (processamento ass√≠ncrono) |
| `GET` | `/api/sales/{id}` | Detalhar uma venda espec√≠fica |
| `GET` | `/api/reports/sales` | Gerar relat√≥rio de vendas com filtros |

---

## ‚ö° Otimiza√ß√µes e Estrat√©gias

- **Decremento at√¥mico:** evita race conditions em atualiza√ß√µes concorrentes de estoque (`UPDATE ... WHERE quantity >= ?`).
- **Locks por produto:** via `InventoryLockService` (Redis lock) para serializar atualiza√ß√µes.
- **Transa√ß√µes e idempot√™ncia:** todas as opera√ß√µes cr√≠ticas executadas com rollback seguro.
- **Cache versionado:** invalida√ß√£o de listas via chave `inventory:list_version`.
- **Processamento ass√≠ncrono:** filas para vendas e atualiza√ß√£o de estoque.
- **Observabilidade m√≠nima:** m√©tricas de jobs, cache e invent√°rio expostas via endpoint.
- **Testes de concorr√™ncia:** garantem integridade e rollback correto sob carga.

Essas pr√°ticas asseguram **consist√™ncia**, **baixa lat√™ncia** e **facilidade operacional**.

---

## üß≠ Valida√ß√£o Local

1. Migrar e popular banco:
   ```bash
   docker compose exec backend php artisan migrate --seed
   ```

2. Criar uma venda:
   ```bash
   curl -X POST http://localhost:8000/api/v1/sales \
   -H 'Content-Type: application/json' \
   -d '{"items":[{"product_id":1,"quantity":2,"unit_price":100.0}]}'
   ```

3. Processar fila e validar estoque:
   ```bash
   docker compose exec backend php artisan queue:work --once
   ```

4. Consultar m√©tricas:
   ```bash
   curl http://localhost:8000/api/v1/observability/metrics
   ```

---

## ‚úÖ Cobertura de C√≥digo (atual)

No √∫ltimo relat√≥rio de cobertura gerado (veja `coverage/`), a cobertura total est√° em aproximadamente **80.7%**. Um screenshot anexo mostra que pastas como `Http` e `Infrastructure` t√™m cobertura mais baixa e s√£o bons alvos para prioriza√ß√£o.

![Coverage screenshot](https://raw.githubusercontent.com/davidaugusto89/api-de-controle-de-estoque-e-vendas/refs/heads/main/docs/coverage-screenshot.png)


> ‚ö†Ô∏è **Aten√ß√£o**
> **Recomenda√ß√£o:** aumentar a cobertura para **90%+** como meta de m√©dio prazo,
> priorizando **testes de integra√ß√£o** e **casos de borda** nas camadas com menor cobertura.



## üöß Melhorias Futuras

- Integra√ß√£o com **Prometheus** ou **Grafana** para m√©tricas avan√ßadas.
- Implementa√ß√£o de **CI/CD** (GitHub Actions) com PHPUnit e Pint.
- Configura√ß√£o de **Sentry** para monitoramento de exce√ß√µes.
- Exposi√ß√£o de **API Docs (Swagger)** automatizada.
- Adi√ß√£o de **autentica√ß√£o JWT** e controle de permiss√µes.
- Aumentar cobertura de testes para **90%+**; priorizar pastas com baixa cobertura (`Http`, `Infrastructure`) e criar testes de integra√ß√£o para fluxos cr√≠ticos (vendas, atualiza√ß√£o de estoque, jobs idempotentes).

---

## üë®‚Äçüíª Autor

**David Augusto**

